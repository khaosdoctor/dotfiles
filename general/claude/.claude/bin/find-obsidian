#!/usr/bin/env sh
# Finds and launches the Obsidian MCP server binary.
#
# For vault path discovery, prefer `obsidian vault info=path` (CLI v1.12+).
# This script is kept for the MCP server launch use case, which
# setup-obsidian-mcp references.
#
# Usage:
#   find-obsidian --vault          Print the vault root path
#   find-obsidian --mcp            Find and exec the MCP server binary
#   find-obsidian                  Same as --vault

set -e

find_vault() {
  # Prefer the native Obsidian CLI (v1.12+)
  if command -v obsidian >/dev/null 2>&1; then
    vault=$(obsidian vault info=path 2>/dev/null)
    if [ -n "$vault" ] && [ -d "$vault/.obsidian" ]; then
      echo "$vault"
      return 0
    fi
  fi

  # Fallback: check common paths
  if [ -d "$HOME/Documents/Obsidian" ]; then
    vault=$(find "$HOME/Documents/Obsidian" -maxdepth 2 -name ".obsidian" -type d 2>/dev/null | head -1)
    if [ -n "$vault" ]; then
      dirname "$vault"
      return 0
    fi
  fi

  echo "Error: No Obsidian vault found" >&2
  return 1
}

case "${1:---vault}" in
  --vault)
    find_vault
    ;;
  --mcp)
    VAULT=$(find_vault)
    SERVER="$VAULT/.obsidian/plugins/mcp-tools/bin/mcp-server"
    if [ ! -f "$SERVER" ]; then
      echo "Error: MCP server not found at $SERVER" >&2
      exit 1
    fi
    exec "$SERVER"
    ;;
  *)
    echo "Usage: find-obsidian [--vault|--mcp]" >&2
    exit 1
    ;;
esac
